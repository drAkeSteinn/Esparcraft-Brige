// This is your Prisma schema file,
// learn more about it in docs: https://pris.ly/d/prisma-schema
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id        String   @id @default(cuid())
  title     String
  content   String?
  published Boolean  @default(false)
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Npc Model - Migrado desde sistema de archivos JSON
model Npc {
  id             String   @id @default(cuid())
  locationScope  String   // 'mundo' | 'pueblo' | 'edificio'
  worldId        String
  puebloId       String?
  edificioId     String?
  card           String   // JSON string of SillyTavernCard
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones FK hacia entidades padre
  mundo          World?     @relation("Npc_Mundo", fields: [worldId], references: [id])
  pueblo         Pueblo?    @relation("Npc_Pueblo", fields: [puebloId], references: [id])
  edificio       Edificio?   @relation("Npc_Edificio", fields: [edificioId], references: [id])

  // Relaciones hacia entidades hijas
  sessions       Session[]  @relation("Session_Npc")

  @@index([worldId])
  @@index([puebloId])
  @@index([edificioId])
  @@index([locationScope])
}

// World Model - Mundos/Universos
model World {
  id             String   @id @default(cuid())
  name           String
  lore           String   // JSON string: {rumores, eventos}
  area           String?  // JSON string of {start, end}
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones FK
  npcs           Npc[]      @relation("Npc_Mundo")
  edificios      Edificio[] @relation("Edificio_Mundo")
  pueblos        Pueblo[]    @relation("Pueblo_Mundo")
}

// Pueblo Model - Pueblos/Naciones
model Pueblo {
  id             String   @id @default(cuid())
  worldId        String
  name           String
  type           String   // 'pueblo' | 'nacion'
  description    String
  lore           String   // JSON string de {estado_pueblo, rumores, eventos}
  area           String?  // JSON string de {start, end}
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relaciones FK
  mundo          World?     @relation("Pueblo_Mundo", fields: [worldId], references: [id])
  edificios      Edificio[] @relation("Edificio_Pueblo")
  npcs           Npc[]      @relation("Npc_Pueblo")

  @@index([worldId])
}

// Edificio Model - Edificios/Lugares
model Edificio {
  id                  String   @id @default(cuid())
  worldId             String
  puebloId            String
  name                String
  lore                String   // Plain text description
  rumores             String?  // JSON string
  eventos             String?  // JSON string
  eventos_recientes  String?  // JSON string
  area                String   // JSON string de {start, end}
  puntosDeInteres    String?  // JSON string de PointOfInterest[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relaciones FK
  mundo              World?     @relation("Edificio_Mundo", fields: [worldId], references: [id])
  pueblo             Pueblo?    @relation("Edificio_Pueblo", fields: [puebloId], references: [id])
  npcs               Npc[]      @relation("Npc_Edificio")

  @@index([worldId])
  @@index([puebloId])
}

// PlaceType Model - Tipos de lugares para POIs
model PlaceType {
  id          String   @id @default(cuid())
  name        String   // Nombre del tipo de lugar (ej: 'Puerta', 'Mesa')
  icon        String   // Icono de Lucide (ej: 'Door', 'Table', 'Monitor')
  color       String?  // Color personalizado opcional (ej: '#FF5733', '#3498DB')
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Session Model - Sesiones de chat
model Session {
  id             String   @id @default(cuid())
  npcId          String
  playerId       String?
  jugador        String   // JSON string de Jugador
  startTime      DateTime @default(now())
  lastActivity   DateTime @updatedAt
  messages       String   // JSON string de ChatMessage[]
  lastPrompt     String?
  summary        String?  // Resumen más reciente (opcional, para compatibilidad)
  summaryId      String?  // FK al último resumen (opcional)

  // Relaciones FK
  npc            Npc?       @relation("Session_Npc", fields: [npcId], references: [id])

  @@index([npcId])
  @@index([playerId])
  @@index([startTime])
  @@index([lastActivity])
  @@index([summaryId])
}

// SessionSummary Model - Resúmenes de sesiones
model SessionSummary {
  id             String   @id @default(cuid())
  sessionId      String
  npcId          String
  playerId       String?
  playerName     String?
  npcName        String?
  summary        String
  timestamp      DateTime @default(now())
  version        Int      @default(1)

  @@index([sessionId])
  @@index([npcId])
  @@index([playerId])
  @@index([timestamp])
}

// SystemConfig - Configuración y estado del sistema
model SystemConfig {
  id             String   @id @default(cuid())
  key            String   @unique // 'resumen_general_status'
  value          String   // 'idle' | 'running' | 'error'
  updatedAt      DateTime @updatedAt
  metadata       String?  // JSON con información adicional (fase actual, progreso, configuración)

  @@index([key])
}

// NPC Summary - Resúmenes consolidados de NPCs
model NpcSummary {
  id             String   @id @default(cuid())
  npcId          String
  summary        String
  version        Int      @default(1)
  sessionHash    String   // Hash de los resúmenes de sesiones usados para generar este resumen
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([npcId])
  @@index([sessionHash])
}

// Edificio Summary - Resúmenes consolidados de edificios
model EdificioSummary {
  id             String   @id @default(cuid())
  edificioId     String
  summary        String
  version        Int      @default(1)
  npcHash        String   // Hash de los resúmenes de NPCs usados
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([edificioId])
  @@index([npcHash])
}

// Pueblo Summary - Resúmenes consolidados de pueblos
model PuebloSummary {
  id             String   @id @default(cuid())
  puebloId       String
  summary        String
  version        Int      @default(1)
  edificioHash   String   // Hash de los resúmenes de edificios usados
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([puebloId])
  @@index([edificioHash])
}

// World Summary - Resúmenes consolidados de mundos
model WorldSummary {
  id             String   @id @default(cuid())
  worldId        String
  summary        String
  version        Int      @default(1)
  puebloHash     String   // Hash de los resúmenes de pueblos usados
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([worldId])
  @@index([puebloHash])
}
